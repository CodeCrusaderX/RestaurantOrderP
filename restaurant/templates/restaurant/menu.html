{% extends 'restaurant/base.html' %}

{% block content %}
<div class="navbar">
    <div class="brand">Table {{ table.number }}</div>
    <div style="display: flex; gap: 10px;">
        {% if active_order %}
        <a href="{% url 'order_status' table.id %}" class="btn"
            style="padding: 8px 12px; font-size: 0.8rem; background: #333;">Status</a>
        {% endif %}
    </div>
</div>

<div class="container" style="padding-bottom: 80px;">
    <!-- Search -->
    <div style="position: sticky; top: 70px; background: var(--bg-color); z-index: 90; padding: 10px 0;">
        <input type="text" id="searchInput" placeholder="Search for dishes..." onkeyup="filterMenu()">
    </div>

    <!-- Categories -->
    <div class="category-scroller">
        <div class="cat-pill active" onclick="scrollToCat('all', this)">All</div>
        {% for cat in categories %}
        <div class="cat-pill" onclick="scrollToCat('cat-{{ cat.id }}', this)">{{ cat.name }}</div>
        {% endfor %}
    </div>

    <!-- Menu Items -->
    <div id="menu-list">
        {% for cat in categories %}
        <div id="cat-{{ cat.id }}" class="menu-category-section">
            <h3 style="color: var(--secondary-text); margin: 20px 0 10px;">{{ cat.name }}</h3>
            {% for item in cat.items.all %}
            <div class="menu-item" data-name="{{ item.name|lower }}">
                <div class="item-info">
                    <h4>{{ item.name }}</h4>
                    <span class="item-price">â‚¹{{ item.price }}</span>
                </div>
                <div class="qty-control">
                    <div class="qty-btn" onclick="updateQty({{ item.id }}, -1)">-</div>
                    <div class="qty-val" id="qty-{{ item.id }}">0</div>
                    <div class="qty-btn" onclick="updateQty({{ item.id }}, 1)">+</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bottom Action -->
<button id="fab-submit" class="btn btn-primary btn-block fab-checkout" onclick="submitOrder()" style="display: none;">
    Ask To Prepare <span id="cart-count">(0)</span>
</button>

<script>
    let cart = {}; // {itemId: qty}

    function updateQty(id, change) {
        if (!cart[id]) cart[id] = 0;
        cart[id] += change;
        if (cart[id] < 0) cart[id] = 0;

        // Update UI
        document.getElementById(`qty-${id}`).innerText = cart[id];

        // Update FAB
        updateFab();
    }

    function updateFab() {
        let totalQty = 0;
        for (let key in cart) {
            totalQty += cart[key];
        }

        const btn = document.getElementById('fab-submit');
        const count = document.getElementById('cart-count');

        if (totalQty > 0) {
            btn.style.display = 'block';
            count.innerText = `(${totalQty} items)`;
        } else {
            btn.style.display = 'none';
        }
    }

    function filterMenu() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.menu-item');

        items.forEach(item => {
            const name = item.getAttribute('data-name');
            if (name.includes(input)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function scrollToCat(id, el) {
        // Highlight pill
        document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
        el.classList.add('active');

        if (id === 'all') {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            const section = document.getElementById(id);
            if (section) {
                const y = section.getBoundingClientRect().top + window.pageYOffset - 140;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        }
    }

    async function submitOrder() {
        // Collect items
        const items = [];
        for (let key in cart) {
            if (cart[key] > 0) {
                items.push({ id: key, quantity: cart[key] });
            }
        }

        if (items.length === 0) return;

        const btn = document.getElementById('fab-submit');
        btn.innerText = "Sending to Kitchen...";
        btn.disabled = true;

        try {
            const response = await fetch("{% url 'submit_order' table.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ items: items })
            });

            if (response.ok) {
                window.location.href = "{% url 'order_status' table.id %}";
            } else {
                alert("Something went wrong");
                btn.disabled = false;
                btn.innerText = "Ask To Prepare";
            }
        } catch (e) {
            console.error(e);
            alert("Network Error");
            btn.disabled = false;
        }
    }
</script>
{% endblock %}